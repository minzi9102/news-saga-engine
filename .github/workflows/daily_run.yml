name: Daily News Saga Run

on:
  # 1. å®šæ—¶è§¦å‘ (Cron è¯­æ³•)
  schedule:
    # åŒ—äº¬æ—¶é—´ 20:30 (UTC 12:30)
    - cron: '30 12 * * *'
  
  # 2. å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

permissions:
  contents: write

jobs:
  run-saga:
    runs-on: ubuntu-latest
    
    steps:
    # A. æ‹‰å–ä»£ç 
    - name: Checkout code
      uses: actions/checkout@v4

    # B. è®¾ç½® Python ç¯å¢ƒ
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        cache: 'pip'

    # C. å®‰è£…ä¾èµ–
    - name: Install Dependencies
      run: |
        pip install -r requirements.txt
        # Crawl4AI ä¾èµ– Playwright
        python -m playwright install --with-deps chromium

    # D1. ç¬¬ä¸€æ­¥ï¼šæ•°æ®é‡‡é›† (ä¸æ¶ˆè€— Tokenï¼Œä¸éœ€è¦ Secrets)
    - name: Step 1 - Fetch Data
      run: |
        python run_fetch.py

    # D2. ç¬¬äºŒæ­¥ï¼šåˆ†æä¸æŠ¥å‘Š (éœ€è¦ LLM Key å’Œ é‚®ä»¶é…ç½®)
    - name: Step 2 - Analyze & Report
      env:
        # --- LLM é…ç½® ---
        LLM_API_KEY: ${{ secrets.LLM_API_KEY }}
        LLM_BASE_URL: ${{ secrets.LLM_BASE_URL }}
        LLM_MODEL: ${{ secrets.LLM_MODEL }}
        
        # --- é‚®ä»¶é…ç½® (æ–°å¢) ---
        # ç¡®ä¿ä½ åœ¨ GitHub Secrets ä¸­é…ç½®äº†è¿™äº›å€¼
        ENABLE_EMAIL: "true"
        SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
        SMTP_PORT: ${{ secrets.SMTP_PORT }}
        SMTP_USER: ${{ secrets.SMTP_USER }}
        SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
        EMAIL_TO: ${{ secrets.EMAIL_TO }}
      run: |
        python run_report.py

    # E. æäº¤å¹¶æ¨é€ç»“æœ
    - name: Commit and Push changes
      run: |
        git config --global user.name "SagaBot"
        git config --global user.email "actions@github.com"
        
        # æ·»åŠ æ•°æ®ç›®å½•ã€Markdown æŠ¥å‘Šå’Œ HTML æŠ¥å‘Š
        git add README.md report.html data/
        
        # æäº¤ (å¦‚æœæ— å˜åŒ–åˆ™å¿½ç•¥æŠ¥é”™)
        git commit -m "ğŸš€ Auto-update: Daily Saga [$(date +'%Y-%m-%d')]" || exit 0
        
        # æ¨é€
        git push