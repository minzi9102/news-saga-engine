# src/notifier.py
import smtplib
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart
from email.utils import formataddr
from typing import Optional
import os

class EmailNotifier:
    def __init__(self):
        # ä¼˜å…ˆä»ç¯å¢ƒå˜é‡è·å–ï¼Œå¦‚æœæ²¡æœ‰åˆ™ç•™ç©º (éœ€è¦åœ¨ .env æˆ– GitHub Secrets é…ç½®)
        self.smtp_server = os.getenv("SMTP_SERVER", "smtp.qq.com")
        self.smtp_port = int(os.getenv("SMTP_PORT", "465"))
        self.sender_email = os.getenv("SMTP_USER") # æ‚¨çš„é‚®ç®±
        self.password = os.getenv("SMTP_PASSWORD") # æ‚¨çš„æˆæƒç 
        self.receiver_email = os.getenv("EMAIL_TO") # æ¥æ”¶ç®€æŠ¥çš„é‚®ç®±

    def send_daily_report(self, date_str: str, markdown_content: str):
        if not all([self.sender_email, self.password, self.receiver_email]):
            print("âš ï¸ [Notifier] ç¼ºå°‘é‚®ä»¶é…ç½®ï¼Œè·³è¿‡å‘é€ã€‚")
            return

        print(f"ğŸ“§ æ­£åœ¨é€šè¿‡ {self.smtp_server} å‘é€é‚®ä»¶...")
        
        try:
            msg = MIMEMultipart()
            msg['From'] = formataddr(["News Saga Bot", self.sender_email])
            msg['To'] = self.receiver_email
            msg['Subject'] = f"ğŸ“° æ–°é—»ç®€æŠ¥ ({date_str}) - News Saga"

            # ç®€å•çš„ Markdown è½¬ HTML åŒ…è£… (ä¸ºäº†æ‰‹æœºé˜…è¯»ä½“éªŒ)
            # è¿™é‡Œåšä¸€ä¸ªæœ€ç®€è½¬æ¢ï¼Œå°†æ¢è¡Œç¬¦æ¢æˆ <br>ï¼Œä¿ç•™åŸºæœ¬å¯è¯»æ€§
            # å¦‚æœæƒ³æ›´æ¼‚äº®ï¼Œå¯ä»¥å¼•å…¥ markdown2 åº“ï¼Œä½†ä¸ºäº†å‡å°‘ä¾èµ–ï¼Œè¿™é‡Œç”¨çº¯æ–‡æœ¬å±•ç¤º
            html_content = f"""
            <html>
            <body>
                <pre style="font-family: sans-serif; white-space: pre-wrap;">
{markdown_content}
                </pre>
                <p style="color: gray; font-size: 12px;">Auto-generated by News Saga Engine</p>
            </body>
            </html>
            """
            
            msg.attach(MIMEText(html_content, 'html', 'utf-8'))

            with smtplib.SMTP_SSL(self.smtp_server, self.smtp_port) as server:
                server.login(self.sender_email, self.password)
                server.sendmail(self.sender_email, [self.receiver_email], msg.as_string())
            
            print("âœ… é‚®ä»¶å‘é€æˆåŠŸ!")

        except Exception as e:
            print(f"âŒ é‚®ä»¶å‘é€å¤±è´¥: {e}")