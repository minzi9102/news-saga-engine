# src/reporter.py
import os
import json
from pathlib import Path
from typing import List, Optional

# å¼•å…¥æ•°æ®ç»“æ„
from .schema import DailyBriefing, NewsType, Saga, SagaStatus

class SagaReporter:
    def __init__(self, saga_db_dir: str = "data/sagas"):
        self.saga_db_dir = Path(saga_db_dir)
    
    def _load_all_sagas(self) -> List[Saga]:
        """ä»ç£ç›˜è¯»å–æ‰€æœ‰ Saga çŠ¶æ€æ–‡ä»¶"""
        sagas = []
        if not self.saga_db_dir.exists():
            return sagas
            
        for file_path in self.saga_db_dir.glob("*.json"):
            try:
                with open(file_path, 'r', encoding='utf-8') as f:
                    data = json.load(f)
                    sagas.append(Saga(**data))
            except Exception as e:
                print(f"âš ï¸ åŠ è½½ Saga å¤±è´¥ {file_path}: {e}")
        
        # æŒ‰æœ€åæ›´æ–°æ—¶é—´å€’åºæ’åˆ— (æœ€è¿‘å‘ç”Ÿçš„åœ¨å‰é¢)
        sagas.sort(key=lambda x: x.last_updated, reverse=True)
        return sagas

    def _render_sagas_section(self, sagas: List[Saga]) -> str:
        """æ¸²æŸ“ Story åŒºåŸŸ (æ™ºèƒ½å™äº‹)"""
        if not sagas:
            return "*(æš‚æ— æ´»è·ƒçš„æ•…äº‹çº¿)*"
            
        md_lines = ["## ğŸ“– æ­£åœ¨è¿½è¸ªçš„æ•…äº‹çº¿ (Active Sagas)"]
        
        for saga in sagas:
            # åªæ˜¾ç¤ºæ´»è·ƒçš„ï¼Œæˆ–è€…æœ€è¿‘æ›´æ–°çš„
            if saga.status == SagaStatus.ARCHIVED:
                continue
                
            # æ¸²æŸ“å•ä¸ªå¡ç‰‡
            icon = "ğŸ”¥" if saga.status == SagaStatus.ACTIVE else "ğŸ’¤"
            md_lines.append(f"### {icon} {saga.title}")
            md_lines.append(f"> **åˆ†ç±»**: {saga.category} | **æ›´æ–°**: {saga.last_updated}")
            md_lines.append(f"")
            md_lines.append(f"{saga.context_summary}")
            md_lines.append(f"")
            
            # æ¸²æŸ“æœ€æ–°äº‹ä»¶ (å–æœ€å3ä¸ª)
            md_lines.append(f"**æœ€æ–°è¿›å±•:**")
            for event in saga.events[-3:]: # åªæ˜¾ç¤ºæœ€è¿‘3æ¡
                stars = "â­" * event.importance
                md_lines.append(f"- {event.date} {stars} **{event.title}**: {event.summary} [ğŸ”—]({event.source_url})")
            
            md_lines.append("---")
            
        return "\n".join(md_lines)

    def _render_daily_archive(self, briefing: Optional[DailyBriefing]) -> str:
        """
        [æ–°å¢] æ¸²æŸ“ä»Šæ—¥å…¨é‡æ¡£æ¡ˆ (æŠ˜å è¡¨æ ¼)
        """
        if not briefing:
            return ""
            
        items = briefing.news_items
        count = len(items)
        date = briefing.date
        
        md_lines = []
        md_lines.append(f"## ğŸ—„ï¸ ä»Šæ—¥åŸå§‹æ¡£æ¡ˆ ({date})")
        md_lines.append(f"å…±é‡‡é›† {count} æ¡æ–°é—»ã€‚ç‚¹å‡»ä¸‹æ–¹å±•å¼€æŸ¥çœ‹å…¨é‡åˆ—è¡¨ã€‚")
        md_lines.append("")
        
        # ä½¿ç”¨ HTML <details> æ ‡ç­¾å®ç°æŠ˜å 
        md_lines.append(f"<details><summary><b>ğŸ–±ï¸ ç‚¹å‡»å±•å¼€/æ”¶èµ·ä»Šæ—¥å…¨é‡æ–°é—» ({count}æ¡)</b></summary>")
        md_lines.append("")
        md_lines.append("| ç±»å‹ | æ ‡é¢˜ | æ¥æº |")
        md_lines.append("| :--- | :--- | :--- |")
        
        for item in items:
            # å›¾æ ‡åŒºåˆ†
            type_icon = "âš¡" if item.type == NewsType.FLASH_SUB else "ğŸ“º"
            type_text = "å¿«è®¯" if item.type == NewsType.FLASH_SUB else "æ™®é€š"
            
            # æ ‡é¢˜å¤„ç† (å¦‚æœæ˜¯å¿«è®¯ï¼Œå¯èƒ½å¾ˆé•¿ï¼Œæˆªæ–­ä¸€ç‚¹? æš‚æ—¶å…¨æ˜¾ç¤º)
            title = item.title.replace("|", "\|") # è½¬ä¹‰è¡¨æ ¼ç¬¦
            
            # é“¾æ¥
            link = f"[Link]({item.url})"
            
            md_lines.append(f"| {type_icon} {type_text} | {title} | {link} |")
            
        md_lines.append("")
        md_lines.append("</details>")
        md_lines.append("")
        
        return "\n".join(md_lines)

    def generate_readme(self, file_path: str = "README.md", briefing: Optional[DailyBriefing] = None):
        """
        ç”Ÿæˆæœ€ç»ˆçš„ README æŠ¥å‘Š
        :param briefing: å½“æ—¥çš„åŸå§‹æ•°æ®å¯¹è±¡ (ç”¨äºç”Ÿæˆæ¡£æ¡ˆåŒº)
        """
        print(f"ğŸ“ æ­£åœ¨æ¸²æŸ“æŠ¥å‘Š: {file_path}...")
        
        # 1. åŠ è½½ Sagas
        sagas = self._load_all_sagas()
        
        # 2. ç”Ÿæˆå„éƒ¨åˆ†å†…å®¹
        header = f"# ğŸš€ News Saga Engine æ¯æ—¥ç®€æŠ¥"
        saga_section = self._render_sagas_section(sagas)
        archive_section = self._render_daily_archive(briefing) # ä¼ å…¥ raw data
        
        # 3. ç»„åˆ
        full_content = f"""{header}

ç”Ÿæˆæ—¶é—´: {briefing.date if briefing else "Unknown"}

{saga_section}

{archive_section}

---
*Auto-generated by News Saga Engine v2.0*
"""
        
        # 4. å†™å…¥æ–‡ä»¶
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(full_content)
            
        print(f"âœ… æŠ¥å‘Šç”Ÿæˆå®Œæ¯•!")